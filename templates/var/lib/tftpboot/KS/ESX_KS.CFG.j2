# {{ ansible_managed }}
# Sample scripted installation file
# Accept the VMware End User License Agreement
vmaccepteula
# Set the root password for the DCUI and ESXi Shell
{% if esxi_root_pw is defined %}
rootpw {{ esxi_root_pw }}
{% endif %}
{% if esxi_root_pw is not defined %}
rootpw vmware
{% endif %}
# Install on the first local disk available on machine
{{ esxi_install_disk_options }}
{% if esxi_global_network_options is defined %}
{%   for item in esxi_global_network_options %}
{%     if item.create_default_portgroup %}
network --bootproto={{ item.bootproto }} --device={{ item.interface }} --addvmportgroup=1
{%     endif %}
{%     if not item.create_default_portgroup %}
network --bootproto={{ item.bootproto }} --device={{ item.interface }} --addvmportgroup=0
{%     endif %}
{%   endfor %}
{% endif %}
# Set the network to DHCP on the first network adapater, use the specified hostname and do not create a portgroup for the VMs
# network --bootproto=dhcp --device=vmnic0 --addvmportgroup=0
# network --bootproto=static --device=vmnic0 --ip=10.0.106.11 --gateway=10.0.106.1 --nameserver=10.0.101.111,10.0.101.112 --netmask=255.255.255.0 --hostname=esxi01.everythingshouldbevirtual.local --addvmportgroup=0
# reboots the host after the scripted installation is completed
reboot

%firstboot --interpreter=busybox
{% if esxi_enable_ssh_and_shell is defined and esxi_enable_ssh_and_shell %}
# Enable SSH and the ESXi Shell
vim-cmd hostsvc/enable_ssh
vim-cmd hostsvc/start_ssh
vim-cmd hostsvc/enable_esx_shell
vim-cmd hostsvc/start_esx_shell
# Suppress Shell Warning in Host
esxcli system settings advanced set -o /UserVars/SuppressShellWarning -i 1
esxcli system settings advanced set -o /UserVars/ESXiShellTimeOut -i 1
{% endif %}
{% if esxi_enable_snmp is defined and esxi_enable_snmp %}
{%   for item in esxi_snmp_options %}
# Enable SNMP and configure SNMP
esxcli system snmp set --communities {{ item.community }}
esxcli system snmp set --enable true
{%   endfor %}
{% endif %}
# Enter Maintenance Mode
vim-cmd hostsvc/maintenance_mode_enter
{% if esxi_install_vibs is defined and esxi_install_vibs %}
{%   for item in esxi_vibs %}
esxcli software vib install -v {{ item }}
{%   endfor %}
{% endif %}
{% if esxi_enable_snmp is defined and esxi_enable_snmp %}
# Configure Firewall to allow SNMP
{%   for item in esxi_snmp_options %}
esxcli network firewall ruleset set --ruleset-id snmp --allowed-all false
esxcli network firewall ruleset allowedip add --ruleset-id snmp --ip-address {{ item.allowed_from }}
esxcli network firewall ruleset set --ruleset-id snmp --enabled true
{%   endfor %}
/etc/init.d/snmpd restart
{% endif %}
# Exit Maintenance Mode
vim-cmd hostsvc/maintenance_mode_exit
# Add vmnic3 to vSwitch0
# esxcli network vswitch standard uplink add --uplink-name vmnic3 --vswitch-name vSwitch0
# Reboot host one last time
reboot
